<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TripSplit Offline</title>
    
    <!-- Lưu ý: Để offline 100%, các link script dưới đây nên được tải về máy và để cùng thư mục 
         tuy nhiên Service Worker sẽ giúp bạn "cache" chúng sau lần đầu có mạng -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .animate-bounce-in { animation: bounce-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes bounce-in { 0% { transform: translateY(-20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <!-- SERVICE WORKER REGISTRATION (Bùa hộ mệnh Offline) -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'tripsplit-v1';
                    const ASSETS = [
                        './',
                        './index.html',
                        'https://cdn.tailwindcss.com',
                        'https://unpkg.com/react@18/umd/react.production.min.js',
                        'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js',
                        'https://unpkg.com/@babel/standalone/babel.min.js',
                        'https://unpkg.com/lucide@latest'
                    ];

                    self.addEventListener('install', (e) => {
                        e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(ASSETS)));
                    });

                    self.addEventListener('fetch', (e) => {
                        e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
                    });
                `;
                const blob = new Blob([swCode], { type: 'text/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl).then(() => console.log('Offline Ready!'));
            });
        }
    </script>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const Icon = ({ name, className }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        const App = () => {
            // Dữ liệu Offline lưu vào LocalStorage
            const [members, setMembers] = useState(() => JSON.parse(localStorage.getItem('off_members') || '[]'));
            const [expenses, setExpenses] = useState(() => JSON.parse(localStorage.getItem('off_expenses') || '[]'));
            const [contributions, setContributions] = useState(() => JSON.parse(localStorage.getItem('off_contributions') || '[]'));

            useEffect(() => {
                localStorage.setItem('off_members', JSON.stringify(members));
                localStorage.setItem('off_expenses', JSON.stringify(expenses));
                localStorage.setItem('off_contributions', JSON.stringify(contributions));
            }, [members, expenses, contributions]);

            // UI State
            const [activeTab, setActiveTab] = useState('report');
            const [newMemberName, setNewMemberName] = useState('');

            // Logic tính toán
            const stats = useMemo(() => {
                const totalSpent = expenses.reduce((sum, e) => sum + e.amount, 0);
                const totalCashIn = contributions.reduce((sum, c) => sum + c.amount, 0);
                const currentFund = totalCashIn - expenses.filter(e => e.payerId === 'fund').reduce((sum, e) => sum + e.amount, 0);
                
                const mStats = members.map(m => {
                    const cash = contributions.filter(c => c.memberId === m.id).reduce((s, c) => s + c.amount, 0);
                    const help = expenses.filter(e => e.payerId === m.id).reduce((s, e) => s + e.amount, 0);
                    const enjoyed = expenses.reduce((s, e) => (e.splitWith?.includes(m.id) ? s + (e.amount / e.splitWith.length) : s), 0);
                    return { ...m, balance: (cash + help) - enjoyed };
                });
                return { totalSpent, currentFund, mStats };
            }, [members, expenses, contributions]);

            return (
                <div className="max-w-md mx-auto min-h-screen pb-24 relative">
                    <header className="p-6 pb-12 rounded-b-[3rem] bg-slate-900 text-white shadow-xl sticky top-0 z-40">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="font-black italic uppercase tracking-tighter flex items-center gap-2">
                                <Icon name="zap-off" className="text-amber-400" /> Offline Mode
                            </h1>
                            <div className="bg-emerald-500/20 text-emerald-400 px-3 py-1 rounded-full text-[10px] font-black uppercase">Đã lưu máy</div>
                        </div>
                        <div className="bg-white/10 backdrop-blur-md rounded-[2rem] p-4 border border-white/20 flex justify-around text-center">
                            <div><p className="text-[8px] opacity-60 uppercase">Quỹ còn</p><p className="text-xl font-black">{stats.currentFund}K</p></div>
                            <div className="w-px h-8 bg-white/10"></div>
                            <div><p className="text-[8px] opacity-60 uppercase">Tổng chi</p><p className="text-xl font-black">{stats.totalSpent}K</p></div>
                        </div>
                    </header>

                    <main className="p-4 space-y-4">
                        <div className="bg-white p-3 rounded-2xl shadow-sm flex gap-2">
                            <input className="flex-1 px-4 py-2 bg-slate-50 rounded-xl text-sm font-bold outline-none" placeholder="Thêm thành viên..." 
                                value={newMemberName} onChange={e=>setNewMemberName(e.target.value)} />
                            <button onClick={() => {
                                if (!newMemberName) return;
                                setMembers([...members, { id: crypto.randomUUID(), name: newMemberName }]);
                                setNewMemberName('');
                            }} className="p-2 bg-slate-900 text-white rounded-xl"><Icon name="plus"/></button>
                        </div>

                        {members.map(m => (
                            <div key={m.id} className="bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center animate-bounce-in">
                                <span className="font-black uppercase text-sm">{m.name}</span>
                                <div className="text-right">
                                    <p className="text-[10px] text-slate-400 font-bold uppercase">Số dư</p>
                                    <p className={`text-sm font-black ${stats.mStats.find(s=>s.id===m.id)?.balance >= 0 ? 'text-indigo-600' : 'text-rose-500'}`}>
                                        {stats.mStats.find(s=>s.id===m.id)?.balance.toFixed(1)}K
                                    </p>
                                </div>
                            </div>
                        ))}
                    </main>

                    <footer className="fixed bottom-6 left-4 right-4 max-w-md mx-auto bg-amber-100 p-4 rounded-2xl border border-amber-200 text-[10px] font-bold text-amber-700">
                        ⚠️ Chế độ Offline lưu dữ liệu tại Safari. Nếu bạn "Xóa lịch sử và dữ liệu trang web" trong cài đặt iPhone, dữ liệu sẽ mất.
                    </footer>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
